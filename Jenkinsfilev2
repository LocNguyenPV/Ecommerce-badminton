pipeline {
    agent any

    environment {
        // Thông tin GCP - Thay đổi theo Project của bạn
        PROJECT_ID = "devops-476202"
        LOCATION   = "asia-southeast1"
        REPO_NAME  = "ecommerce-repo"
        IMAGE_NAME = "ecommerce-be"
        
        // Đường dẫn đầy đủ của Registry
        REGISTRY_URL = "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}"
        
        // Lấy Build Number làm Tag (như số 13 bạn đang dùng)
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // ID của Secret File chứa JSON Key trong Jenkins
        GCP_CREDS_ID = "gcp-service-account-key"
    }

    stages {
        stage('Checkout Source') {
            steps {
                checkout scm
            }
        }

        stage('GCP Authentication') {
            steps {
                // Sử dụng Secret File để login gcloud
                withCredentials([file(credentialsId: "${GCP_CREDS_ID}", variable: 'GCP_KEY')]) {
                    sh "gcloud auth activate-service-account --key-file=${GCP_KEY}"
                    sh "gcloud auth configure-docker ${LOCATION}-docker.pkg.dev --quiet"
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Build image và gắn tag
                    sh "docker build -t ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG} ."
                    sh "docker tag ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:latest"
                }
            }
        }

        stage('Push to Artifact Registry') {
            steps {
                script {
                    // Push cả bản build number và bản latest
                    sh "docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
                    sh "docker push ${REGISTRY_URL}/${IMAGE_NAME}:latest"
                }
            }
        }

        stage('Update K8s Manifest') {
            steps {
                // Stage này tự động sửa file YAML trong repo k8s để ArgoCD tự sync
                script {
                    sh """
                        sed -i 's|image:.*${IMAGE_NAME}:.*|image: ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}|g' k8s/03-backend.yaml
                    """
                    // Sau đó bạn cần thêm các lệnh git commit & push repo k8s tại đây
                }
            }
        }
    }

    post {
        success {
            echo "Build và Push Image ${IMAGE_TAG} lên GCP thành công!"
        }
        failure {
            echo "Build thất bại, kiểm tra lại log xác thực GCP."
        }
    }
}